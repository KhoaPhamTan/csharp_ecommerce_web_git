@page
@model PetStoreUI.Pages.IndexModel
@{
    var petStores = Model.PetStores;
    var categories = Model.Categories;
    ViewData["Title"] = "Home";
    Layout = "_Layout";
    ViewBag.SelectedCategory = Model.SelectedCategory;
    var userName = User.Identity?.Name;
}

@section Styles {
    <link rel="stylesheet" href="~/css/toastmessage.css" />
}

<main role="main" class="container">
    <div class="category-menu">
        @foreach (var category in categories)
        {
            <a href="?category=@category.Id" class="btn btn-secondary">@category.Name</a>
        }
    </div>
    @if (petStores != null)
    {
        <table class="table pet-table">
            <tbody>
                @for (int i = 0; i < petStores.Count; i += 3)
                {
                    <tr>
                        @for (int j = i; j < i + 3; j++)
                        {
                            if (j < petStores.Count)
                            {
                                <td>
                                    <a href="/PetDetails/@petStores[j].Id">
                                        <img src="@Url.Content("~/" + petStores[j].ImageUrl)" alt="Pet Image" class="pet-image"/>
                                    </a><br />
                                    <strong>Pet Name:</strong> 
                                    <a href="/PetDetails/@petStores[j].Id" class="pet-name-link">@petStores[j].PetName</a><br />
                                    <strong>Category:</strong> @petStores[j].CategoryName<br />
                                    <strong>Price:</strong> $ @petStores[j].Price<br />
                                    <input type="number" id="quantity-@petStores[j].Id" name="quantity" min="1" value="1" class="quantity-input" />
                                    <button class="btn btn-primary" onclick="addToCart(@petStores[j].Id)">Add to Cart</button>
                                </td>
                            }
                            else
                            {
                                <td></td>
                            }
                        }
                    </tr>
                }
            </tbody>
        </table>
    }
</main>

<script>
document.addEventListener('DOMContentLoaded', async function() {
    var cartElement = document.getElementById('cart-count');
    var isAuthenticated = '@(User.Identity.IsAuthenticated.ToString().ToLower())';
    if (cartElement && isAuthenticated === 'true') {
        try {
            console.log('Fetching cart count...');
            const response = await fetch('/cart/count', {
                credentials: 'include' // Ensure cookies are sent with the request
            });
            console.log('Response status:', response.status);
            console.log('Response status text:', response.statusText);
            if (response.ok) {
                const cartCount = await response.json();
                cartElement.textContent = cartCount;
            } else {
                console.error('Failed to fetch cart count:', response.status, response.statusText);
            }
        } catch (error) {
            console.error('Error fetching cart count:', error);
        }
    }
});

async function addToCart(petId) {
    var quantity = document.getElementById('quantity-' + petId).value;
    var cartElement = document.getElementById('cart-count');
    var isAuthenticated = '@(User.Identity.IsAuthenticated.ToString().ToLower())';

    if (isAuthenticated !== 'true') {
        showToast('Please log in to add items to the cart.');
        return;
    }

    try {
        console.log('Adding pet to cart...');
        const response = await fetch('/cart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include', // Ensure cookies are sent with the request
            body: JSON.stringify({ PetId: petId, Quantity: parseInt(quantity) })
        });

        console.log('Response status:', response.status);
        console.log('Response status text:', response.statusText);

        if (response.status === 401) {
            showToast('Please log in to add items to the cart.');
            return;
        }

        if (response.ok) {
            const cartCountResponse = await fetch('/cart/count', {
                credentials: 'include' // Ensure cookies are sent with the request
            });
            if (cartCountResponse.ok) {
                const cartCount = await cartCountResponse.json();
                cartElement.textContent = cartCount;
            } else {
                console.error('Failed to fetch cart count:', cartCountResponse.status, cartCountResponse.statusText);
            }
            showToast('Pet was added to cart.');
        } else {
            showToast('Failed to add pet to cart.');
        }
    } catch (error) {
        showToast('Error adding pet to cart.');
        console.error('Error adding pet to cart:', error);
    }
}

function showToast(message) {
    var toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(function() {
        toast.classList.add('show');
    }, 100);
    setTimeout(function() {
        toast.classList.remove('show');
        document.body.removeChild(toast);
    }, 3000);
}
</script>