@page "{id:int}"
@model PetStoreUI.Pages.PetDetailsModel
@{
    ViewData["Title"] = "Pet Details";
    Layout = "_Layout";
}

@section Styles {
    <link rel="stylesheet" href="~/css/petdetails.css" />
    <link rel="stylesheet" href="~/css/toastmessage.css" />
}

<h1>Pet Details</h1>

<a href="/Index" class="btn btn-secondary">Back to Home</a>

@if (Model.Pet != null)
{
    <div class="pet-details-container">
        <div class="pet-details-card">
            <img src="@Url.Content("~/" + Model.Pet.ImageUrl)" alt="Pet Image" class="pet-image"/>
            <h3>@Model.Pet.PetName</h3>
            <div class="pet-details-info">
                <p><strong>Category:</strong> @Model.Pet.Category.Name</p>
                <p><strong>Gender:</strong> @Model.Pet.Gender</p>
                <p><strong>Description:</strong> @Model.Pet.PetDescription</p>
                <p><strong>Price:</strong> $ @Model.Pet.Price</p>
                <p><strong>Birth Day:</strong> @Model.Pet.BirthDay.ToShortDateString()</p>
                <div class="pet-details-cart-controls">
                    <input type="number" id="quantity-@Model.Pet.Id" name="quantity" min="1" value="1" class="quantity-input" />
                    <button class="btn btn-primary" onclick="addToCart(@Model.Pet.Id)">Add to Cart</button>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <p>Pet details not found.</p>
}

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            var cartElement = document.getElementById('cart-count');
            var isAuthenticated = '@(User.Identity.IsAuthenticated.ToString().ToLower())';
            if (cartElement && isAuthenticated === 'true') {
                try {
                    console.log('Fetching cart count...');
                    const response = await fetch('http://localhost:5134/Cart/count', { // Ensure this matches the API backend address
                        credentials: 'include', // Ensure cookies are sent with the request
                        headers: {
                            'Accept': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest' // Add this header to indicate an AJAX request
                        }
                    });
                    console.log('Response status:', response.status);
                    console.log('Response status text:', response.statusText);
                    if (response.ok) {
                        const cart = await response.json();
                        cartElement.textContent = String(cart.count); // Ensure the count is displayed as a string
                    } else {
                        console.error('Failed to fetch cart count:', response.status, response.statusText);
                    }
                } catch (error) {
                    console.error('Error fetching cart count:', error);
                }
            }
        });

        async function addToCart(petId) {
            var quantity = document.getElementById('quantity-' + petId).value;
            var cartElement = document.getElementById('cart-count');

            try {
                console.log('Adding pet to cart...');
                const response = await fetch('http://localhost:5134/Cart', { // Ensure this matches the API backend address
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include', // Ensure cookies are sent with the request
                    body: JSON.stringify({ PetId: petId, Quantity: parseInt(quantity) })
                });

                console.log('Response status:', response.status);
                console.log('Response status text:', response.statusText);

                if (response.status === 401) {
                    showToast('Please log in to add items to the cart.');
                    return;
                }

                if (response.ok) {
                    const cartCountResponse = await fetch('http://localhost:5134/Cart/count', { // Ensure this matches the API backend address
                        credentials: 'include', // Ensure cookies are sent with the request
                        headers: {
                            'Accept': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest' // Add this header to indicate an AJAX request
                        }
                    });
                    if (cartCountResponse.ok) {
                        const cart = await cartCountResponse.json();
                        cartElement.textContent = String(cart.count); // Ensure the count is displayed as a string
                    } else {
                        console.error('Failed to fetch cart count:', cartCountResponse.status, cartCountResponse.statusText);
                    }
                    showToast('Pet was added to cart.');
                } else {
                    showToast('Failed to add pet to cart.');
                }
            } catch (error) {
                showToast('Error adding pet to cart.');
                console.error('Error adding pet to cart:', error);
            }
        }

        function showToast(message) {
            var toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(function() {
                toast.classList.add('show');
            }, 100);
            setTimeout(function() {
                toast.classList.remove('show');
                document.body.removeChild(toast);
            }, 3000);
        }
    </script>
}